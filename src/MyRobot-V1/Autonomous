#include <WiFiS3.h>

// ========== HOTSPOT CREDENTIALS ==========
const char* ssid = "Brady";
const char* password = "Brady2005";

WiFiServer server(80);

// ========== MOTOR PINS ==========
int enA = 9;
int in1 = 8;
int in2 = 7;
int enB = 10;
int in3 = 12;
int in4 = 13;
int speed = 200;

float leftTrim = 0.6;
float rightTrim = 1.0;

// ========== ULTRASONIC SENSORS ==========
const int trigPin1 = 3;  // Front
const int echoPin1 = 4;
const int trigPin2 = 5;  // Right side
const int echoPin2 = 6;
long cm1, cm2;

// ========== AUTONOMOUS MODE ==========
bool autonomousMode = false;
int baseSpeed = 180;

// SIMPLE thresholds
int wallDetected = 50;      // If right sensor < 50cm, wall is there
int frontObstacle = 25;     // If front sensor < 25cm, obstacle ahead

void setup() {
  pinMode(enA, OUTPUT);
  pinMode(in1, OUTPUT);
  pinMode(in2, OUTPUT);
  pinMode(enB, OUTPUT);
  pinMode(in3, OUTPUT);
  pinMode(in4, OUTPUT);

  digitalWrite(in1, LOW);
  digitalWrite(in2, LOW);
  digitalWrite(in3, LOW);
  digitalWrite(in4, LOW);
  analogWrite(enA, 0);
  analogWrite(enB, 0);

  pinMode(trigPin1, OUTPUT);
  pinMode(echoPin1, INPUT);
  pinMode(trigPin2, OUTPUT);
  pinMode(echoPin2, INPUT);

  Serial.begin(9600);
  delay(2000);
  Serial.println("========================================");
  Serial.println("SIMPLE WALL FOLLOWER");
  Serial.println("========================================");

  Serial.print("Connecting to: ");
  Serial.println(ssid);
  WiFi.begin(ssid, password);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 40) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  Serial.println();
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("Connected!");
    Serial.print("IP: ");
    Serial.println(WiFi.localIP());
    server.begin();
  }
}

void loop() {
  // Read front sensor
  digitalWrite(trigPin1, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin1, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin1, LOW);
  long duration1 = pulseIn(echoPin1, HIGH, 30000);
  cm1 = (duration1 == 0) ? 999 : (duration1 / 2) / 29.1;

  delayMicroseconds(10);

  // Read right side sensor
  digitalWrite(trigPin2, LOW);
  delayMicroseconds(2);
  digitalWrite(trigPin2, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin2, LOW);
  long duration2 = pulseIn(echoPin2, HIGH, 30000);
  cm2 = (duration2 == 0) ? 999 : (duration2 / 2) / 29.1;

  // ========== AUTONOMOUS LOGIC ==========
  if (autonomousMode) {
    // Priority 1: Front obstacle - turn left
    if (cm1 < frontObstacle && cm1 > 0) {
      Serial.println("FRONT OBSTACLE! Turning left...");
      stop();
      delay(300);
      turnLeft();
      delay(500);
      stop();
      delay(200);
    }
    // Priority 2: No wall on right - turn right
    else if (cm2 >= wallDetected || cm2 == 999) {
      Serial.print("NO WALL on right (");
      Serial.print(cm2);
      Serial.println("cm) - Turning right...");
      stop();
      delay(200);
      turnRight();
      delay(500);
      stop();
      delay(200);
    }
    // Priority 3: Wall detected - just go forward
    else {
      Serial.print("Wall detected (");
      Serial.print(cm2);
      Serial.println("cm) - Going forward");
      goForward();
    }
  }

  // ========== WIFI CONTROL ==========
  WiFiClient client = server.available();
  if (client) {
    String currentLine = "";
    while (client.connected()) {
      if (client.available()) {
        char c = client.read();
        if (c == '\n') {
          if (currentLine.length() == 0) {
            sendWebPage(client);
            break;
          } else {
            if (currentLine.indexOf("GET /AUTO_ON") >= 0) {
              autonomousMode = true;
              Serial.println("AUTO MODE ON");
            }
            else if (currentLine.indexOf("GET /AUTO_OFF") >= 0) {
              autonomousMode = false;
              stop();
              Serial.println("AUTO MODE OFF");
            }
            else if (currentLine.indexOf("GET /F") >= 0 && !autonomousMode) {
              goForward();
            }
            else if (currentLine.indexOf("GET /B") >= 0 && !autonomousMode) {
              goBackward();
            }
            else if (currentLine.indexOf("GET /L") >= 0 && !autonomousMode) {
              turnLeft();
            }
            else if (currentLine.indexOf("GET /R") >= 0 && !autonomousMode) {
              turnRight();
            }
            else if (currentLine.indexOf("GET /S") >= 0 && !autonomousMode) {
              stop();
            }
            else if (currentLine.indexOf("GET /data") >= 0) {
              sendTelemetryJSON(client);
              client.stop();
              return;
            }
            currentLine = "";
          }
        } else if (c != '\r') {
          currentLine += c;
        }
      }
    }
    client.stop();
  }

  delay(100);
}

// ========== SIMPLE MOVEMENT FUNCTIONS ==========
void goForward() {
  digitalWrite(in1, LOW);
  digitalWrite(in2, HIGH);
  analogWrite(enA, baseSpeed * leftTrim);
  
  digitalWrite(in3, LOW);
  digitalWrite(in4, HIGH);
  analogWrite(enB, baseSpeed * rightTrim);
}

void goBackward() {
  digitalWrite(in1, HIGH);
  digitalWrite(in2, LOW);
  analogWrite(enA, baseSpeed * leftTrim);
  
  digitalWrite(in3, HIGH);
  digitalWrite(in4, LOW);
  analogWrite(enB, baseSpeed * rightTrim);
}

void turnLeft() {
  digitalWrite(in1, HIGH);
  digitalWrite(in2, LOW);
  analogWrite(enA, baseSpeed * leftTrim);
  
  digitalWrite(in3, LOW);
  digitalWrite(in4, HIGH);
  analogWrite(enB, baseSpeed * rightTrim);
}

void turnRight() {
  digitalWrite(in1, LOW);
  digitalWrite(in2, HIGH);
  analogWrite(enA, baseSpeed * leftTrim);
  
  digitalWrite(in3, HIGH);
  digitalWrite(in4, LOW);
  analogWrite(enB, baseSpeed * rightTrim);
}

void stop() {
  digitalWrite(in1, LOW);
  digitalWrite(in2, LOW);
  analogWrite(enA, 0);
  
  digitalWrite(in3, LOW);
  digitalWrite(in4, LOW);
  analogWrite(enB, 0);
}

// ========== WEB PAGE ==========
void sendWebPage(WiFiClient &client) {
  client.println("HTTP/1.1 200 OK");
  client.println("Content-type:text/html");
  client.println();
  
  client.println("<!DOCTYPE html><html><head>");
  client.println("<meta name='viewport' content='width=device-width, initial-scale=1'>");
  client.println("<title>Robot Control</title>");
  client.println("<style>");
  client.println("body{font-family:Arial;text-align:center;background:#1e1e1e;color:#fff;padding:20px}");
  client.println("h1{color:#4CAF50}");
  client.println(".mode-btn{background:#2196F3;border:none;color:white;padding:20px 40px;font-size:20px;margin:10px;border-radius:10px;width:200px}");
  client.println(".mode-btn.active{background:#ff9800}");
  client.println(".btn{background:#4CAF50;border:none;color:white;padding:15px 25px;font-size:18px;margin:8px;border-radius:10px;min-width:120px}");
  client.println(".stop{background:#f44336}");
  client.println(".row{display:flex;justify-content:center;margin:10px 0}");
  client.println(".telemetry{background:#2d2d2d;padding:20px;margin:30px auto;max-width:400px;border-radius:10px}");
  client.println(".sensor{margin:15px 0;font-size:20px}");
  client.println("</style></head><body>");
  
  client.println("<h1>ðŸ¤– Wall Follower</h1>");
  client.println("<div><button class='mode-btn' id='autoBtn' onclick='setAuto(true)'>AUTONOMOUS</button>");
  client.println("<button class='mode-btn active' id='manualBtn' onclick='setAuto(false)'>MANUAL</button></div>");
  
  client.println("<div id='controls'>");
  client.println("<div class='row'><button class='btn' onclick='send(\"F\")'>FORWARD</button></div>");
  client.println("<div class='row'><button class='btn' onclick='send(\"L\")'>LEFT</button>");
  client.println("<button class='btn stop' onclick='send(\"S\")'>STOP</button>");
  client.println("<button class='btn' onclick='send(\"R\")'>RIGHT</button></div>");
  client.println("<div class='row'><button class='btn' onclick='send(\"B\")'>BACK</button></div></div>");
  
  client.println("<div class='telemetry'><h2>Sensors</h2>");
  client.println("<div class='sensor'>Front: <span id='s1'>--</span> cm</div>");
  client.println("<div class='sensor'>Right: <span id='s2'>--</span> cm</div></div>");
  
  client.println("<script>");
  client.println("function send(c){fetch('/'+c)}");
  client.println("function setAuto(m){");
  client.println("  fetch(m?'/AUTO_ON':'/AUTO_OFF');");
  client.println("  document.getElementById('autoBtn').classList.toggle('active',m);");
  client.println("  document.getElementById('manualBtn').classList.toggle('active',!m);");
  client.println("}");
  client.println("setInterval(()=>{");
  client.println("  fetch('/data').then(r=>r.json()).then(d=>{");
  client.println("    document.getElementById('s1').textContent=d.s1==999?'No obstacle':d.s1;");
  client.println("    document.getElementById('s2').textContent=d.s2==999?'No wall':d.s2;");
  client.println("  })");
  client.println("},500);");
  client.println("</script></body></html>");
}

void sendTelemetryJSON(WiFiClient &client) {
  client.println("HTTP/1.1 200 OK");
  client.println("Content-type:application/json");
  client.println();
  client.print("{\"s1\":");
  client.print(cm1);
  client.print(",\"s2\":");
  client.print(cm2);
  client.println("}");
}