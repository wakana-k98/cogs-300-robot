#include <WiFiS3.h>

// ========== HOTSPOT CREDENTIALS ==========
const char* ssid = "Eric";
const char* password = "eric1234";

WiFiServer server(80);

// ========== MOTOR PINS (L298N) ==========
int enA = 9;
int in1 = 8;
int in2 = 7;

int enB = 10;
int in3 = 12;
int in4 = 13;

// ========== ANALOG IR SENSORS ==========
#define LEFT_IR A0
#define RIGHT_IR A2
#define MIDDLE_IR A1

// ========== LINE FOLLOWING SETTINGS ==========
#define DETECT_LIMIT 300
#define DETECT_SPAN 260

// ========== MOTOR SPEED LIMITS - TUNED FOR YOUR MOTORS ==========
#define LEFT_MIN_SPEED     200    // Left motor needs high power to work
#define LEFT_MAX_SPEED     255    // Left motor at full power
#define RIGHT_MIN_SPEED    60     // Right motor works at low speeds
#define RIGHT_MAX_SPEED    140    // Right motor capped lower to match left
#define BASE_LEFT          230    // Left motor base speed (high)
#define BASE_RIGHT         100    // Right motor base speed (low to match)
#define CORRECTION_STRENGTH 30    // Gentle corrections

// Variables
int left_value;
int right_value;
int middle_value;
char lastDirection = 'S';
bool autonomousMode = false;

float tapeStrength(int sensorValue) {
  float s = (float)(DETECT_LIMIT - sensorValue) / (float)DETECT_SPAN;
  if (s < 0.0) s = 0.0;
  if (s > 1.0) s = 1.0;
  return s;
}

void setup() {
  // Motor setup
  pinMode(enA, OUTPUT); 
  pinMode(in1, OUTPUT); 
  pinMode(in2, OUTPUT);
  pinMode(enB, OUTPUT); 
  pinMode(in3, OUTPUT); 
  pinMode(in4, OUTPUT);

  stopMotors();

  Serial.begin(9600);
  delay(2000);

  Serial.println("========================================");
  Serial.println("LINE FOLLOWER ROBOT - OPTIMIZED");
  Serial.println("========================================");

  // WiFi connect
  Serial.println("Connecting to hotspot...");
  WiFi.begin(ssid, password);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 40) {
    delay(500);
    Serial.print(".");
    attempts++;
  }

  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nConnected!");
    Serial.print("IP Address: ");
    Serial.println(WiFi.localIP());
    server.begin();
  } else {
    Serial.println("\nFailed to connect.");
  }
}

void loop() {
  // ========== AUTONOMOUS LINE FOLLOWING ==========
  if (autonomousMode) {
    followLine();
  }

  // ========== HANDLE WIFI CLIENT ==========
  WiFiClient client = server.available();
  if (client) {
    String currentLine = "";
    while (client.connected()) {
      if (client.available()) {
        char c = client.read();
        if (c == '\n') {
          if (currentLine.length() == 0) {
            sendWebPage(client);
            break;
          } else {

            if (currentLine.indexOf("GET /AUTO_ON") >= 0) {
              autonomousMode = true;
              Serial.println("AUTO MODE: ON");
            }
            else if (currentLine.indexOf("GET /AUTO_OFF") >= 0) {
              autonomousMode = false;
              stopMotors();
              Serial.println("AUTO MODE: OFF");
            }
            else if (currentLine.indexOf("GET /F") >= 0 && !autonomousMode) {
              manualForward();
            }
            else if (currentLine.indexOf("GET /B") >= 0 && !autonomousMode) {
              manualBackward();
            }
            else if (currentLine.indexOf("GET /L") >= 0 && !autonomousMode) {
              manualTurnLeft();
            }
            else if (currentLine.indexOf("GET /R") >= 0 && !autonomousMode) {
              manualTurnRight();
            }
            else if (currentLine.indexOf("GET /S") >= 0 && !autonomousMode) {
              stopMotors();
            }

            currentLine = "";
          }
        } 
        else if (c != '\r') {
          currentLine += c;
        }
      }
    }
    client.stop();
  }

  delay(10);
}

// ========== BALANCED MOTOR CONTROL ==========
// This function balances the weak left motor with the strong right motor
void driveBalanced(int leftSpeed, int rightSpeed) {
  // Constrain left motor (needs high speeds)
  if (leftSpeed > 0) {
    if (leftSpeed < LEFT_MIN_SPEED) leftSpeed = LEFT_MIN_SPEED;
    if (leftSpeed > LEFT_MAX_SPEED) leftSpeed = LEFT_MAX_SPEED;
  } else if (leftSpeed < 0) {
    if (leftSpeed > -LEFT_MIN_SPEED) leftSpeed = -LEFT_MIN_SPEED;
    if (leftSpeed < -LEFT_MAX_SPEED) leftSpeed = -LEFT_MAX_SPEED;
  }
  
  // Constrain right motor (works at low speeds)
  if (rightSpeed > 0) {
    if (rightSpeed < RIGHT_MIN_SPEED) rightSpeed = RIGHT_MIN_SPEED;
    if (rightSpeed > RIGHT_MAX_SPEED) rightSpeed = RIGHT_MAX_SPEED;
  } else if (rightSpeed < 0) {
    if (rightSpeed > -RIGHT_MIN_SPEED) rightSpeed = -RIGHT_MIN_SPEED;
    if (rightSpeed < -RIGHT_MAX_SPEED) rightSpeed = -RIGHT_MAX_SPEED;
  }

  // Left motor control
  if (leftSpeed >= 0) {
    digitalWrite(in1, HIGH);
    digitalWrite(in2, LOW);
    analogWrite(enA, leftSpeed);
  } else {
    digitalWrite(in1, LOW);
    digitalWrite(in2, HIGH);
    analogWrite(enA, -leftSpeed);
  }

  // Right motor control
  if (rightSpeed >= 0) {
    digitalWrite(in3, LOW);
    digitalWrite(in4, HIGH);
    analogWrite(enB, rightSpeed);
  } else {
    digitalWrite(in3, HIGH);
    digitalWrite(in4, LOW);
    analogWrite(enB, -rightSpeed);
  }
}

// ========== SMOOTH PROPORTIONAL LINE FOLLOWING ==========
void followLine() {
  left_value = analogRead(LEFT_IR);
  right_value = analogRead(RIGHT_IR);
  middle_value = analogRead(MIDDLE_IR);

  Serial.print("L: ");
  Serial.print(left_value);
  Serial.print(" | M: ");
  Serial.print(middle_value);
  Serial.print(" | R: ");
  Serial.print(right_value);
  Serial.print(" | ");

  // Convert to tape strength
  float l = tapeStrength(left_value);
  float m = tapeStrength(middle_value);
  float r = tapeStrength(right_value);

  // Sensors are mirrored
  float leftSensor = r;
  float rightSensor = l;
  float centerSensor = m;

  // Calculate error: positive = turn right, negative = turn left
  float error = rightSensor - leftSensor;
  
  // Calculate corrections for each motor
  int leftCorrection = (int)(-error * CORRECTION_STRENGTH);
  int rightCorrection = (int)(error * CORRECTION_STRENGTH);
  
  // CENTER SENSOR ON LINE - smooth proportional control
  if (centerSensor > 0.15) {
    int leftSpeed = BASE_LEFT + leftCorrection;
    int rightSpeed = BASE_RIGHT + rightCorrection;
    
    driveBalanced(leftSpeed, rightSpeed);
    
    Serial.print("SMOOTH | L:");
    Serial.print(leftSpeed);
    Serial.print(" R:");
    Serial.println(rightSpeed);
    lastDirection = 'F';
  }
  // LOST LINE - search mode
  else if (centerSensor < 0.1 && leftSensor < 0.1 && rightSensor < 0.1) {
    if (lastDirection == 'L') {
      driveBalanced(-200, 120);  // Search left (left motor reverse)
      Serial.println("SEARCH LEFT");
    } else {
      driveBalanced(255, -100);  // Search right (right motor reverse)
      Serial.println("SEARCH RIGHT");
    }
  }
  // SHARP LEFT (only left sensor on)
  else if (leftSensor > 0.2 && centerSensor < 0.1) {
    driveBalanced(200, 120);  // Left slower, right faster
    Serial.println("SHARP LEFT");
    lastDirection = 'L';
  }
  // SHARP RIGHT (only right sensor on)
  else if (rightSensor > 0.2 && centerSensor < 0.1) {
    driveBalanced(255, 70);   // Left faster, right slower
    Serial.println("SHARP RIGHT");
    lastDirection = 'R';
  }
  // DEFAULT
  else {
    driveBalanced(220, 90);
    Serial.println("DEFAULT");
  }
  
  delay(2);
}

// ========== MANUAL CONTROL ==========
void manualForward() {
  driveBalanced(240, 110);
}

void manualBackward() {
  driveBalanced(-240, -110);
}

void manualTurnRight() {
  driveBalanced(255, -100);  // Left forward, right backward
}

void manualTurnLeft() {
  driveBalanced(-240, 120);  // Left backward, right forward
}

void stopMotors() {
  digitalWrite(in1, LOW);
  digitalWrite(in2, LOW);
  digitalWrite(in3, LOW);
  digitalWrite(in4, LOW);
  analogWrite(enA, 0);
  analogWrite(enB, 0);
}

// ========== WEB PAGE ==========
void sendWebPage(WiFiClient &client) {
  client.println("HTTP/1.1 200 OK");
  client.println("Content-type:text/html");
  client.println();
  client.println("<!DOCTYPE html><html><head>");
  client.println("<meta name='viewport' content='width=device-width, initial-scale=1'>");
  client.println("<title>Line Follower</title>");
  client.println("</head><body style='text-align:center;font-family:Arial;'>");

  client.println("<h1>ðŸ¤– Line Follower Robot</h1>");
  client.println("<p>Optimized for Mismatched Motors</p>");

  client.println("<button onclick=\"fetch('/AUTO_ON')\" style='font-size:18px;padding:10px;'>AUTO ON</button><br><br>");
  client.println("<button onclick=\"fetch('/AUTO_OFF')\" style='font-size:18px;padding:10px;'>AUTO OFF</button><br><br>");
  client.println("<hr>");

  client.println("<button onclick=\"fetch('/F')\">FORWARD</button><br><br>");
  client.println("<button onclick=\"fetch('/L')\">LEFT</button>");
  client.println("<button onclick=\"fetch('/S')\">STOP</button>");
  client.println("<button onclick=\"fetch('/R')\">RIGHT</button><br><br>");
  client.println("<button onclick=\"fetch('/B')\">BACK</button>");

  client.println("</body></html>");
}
