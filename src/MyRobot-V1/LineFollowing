#include <WiFiS3.h>

// ========== HOTSPOT CREDENTIALS ==========
const char* ssid = "rebecca";
const char* password = "trinity9";

WiFiServer server(80);

// ========== MOTOR PINS (L298N) ==========
int enA = 9;
int in1 = 8;
int in2 = 7;

int enB = 10;
int in3 = 12;
int in4 = 13;

// ========== ANALOG IR SENSORS ==========
#define LEFT_IR A1
#define RIGHT_IR A0

// ========== LINE FOLLOWING SETTINGS ==========
#define DETECT_LIMIT 300          // Adjust this value based on your sensors (higher = detects black)
#define FORWARD_SPEED 60
#define TURN_SHARP_SPEED 150
#define TURN_SLIGHT_SPEED 120
#define DELAY_AFTER_TURN 140
#define BEFORE_TURN_DELAY 10

// Variables to store analog sensor values
int left_value;
int right_value;
char lastDirection = 'S';

// ========== AUTONOMOUS MODE ==========
bool autonomousMode = false;

void setup() {
  // Motor setup
  pinMode(enA, OUTPUT); 
  pinMode(in1, OUTPUT); 
  pinMode(in2, OUTPUT);
  pinMode(enB, OUTPUT); 
  pinMode(in3, OUTPUT); 
  pinMode(in4, OUTPUT);

  stopMotors();

  Serial.begin(9600);
  delay(2000);

  Serial.println("========================================");
  Serial.println("LINE FOLLOWER ROBOT - ANALOG SENSORS");
  Serial.println("========================================");

  // WiFi connect
  Serial.println("Connecting to hotspot...");
  WiFi.begin(ssid, password);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 40) {
    delay(500);
    Serial.print(".");
    attempts++;
  }

  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("\nConnected!");
    Serial.print("IP Address: ");
    Serial.println(WiFi.localIP());
    server.begin();
  } else {
    Serial.println("\nFailed to connect.");
  }

  // Give starting push to robot
  digitalWrite(in1, LOW);
  digitalWrite(in2, HIGH);
  analogWrite(enA, 255);
  digitalWrite(in3, HIGH);
  digitalWrite(in4, LOW);
  analogWrite(enB, 255);
  delay(40);
}

void loop() {
  // ========== AUTONOMOUS LINE FOLLOWING ==========
  if (autonomousMode) {
    followLine();
  }

  // ========== HANDLE WIFI CLIENT ==========
  WiFiClient client = server.available();
  if (client) {
    String currentLine = "";
    while (client.connected()) {
      if (client.available()) {
        char c = client.read();
        if (c == '\n') {
          if (currentLine.length() == 0) {
            sendWebPage(client);
            break;
          } else {

            if (currentLine.indexOf("GET /AUTO_ON") >= 0) {
              autonomousMode = true;
              Serial.println("AUTO MODE: ON");
            }
            else if (currentLine.indexOf("GET /AUTO_OFF") >= 0) {
              autonomousMode = false;
              stopMotors();
              Serial.println("AUTO MODE: OFF");
            }
            else if (currentLine.indexOf("GET /F") >= 0 && !autonomousMode) {
              manualForward();
            }
            else if (currentLine.indexOf("GET /B") >= 0 && !autonomousMode) {
              manualBackward();
            }
            else if (currentLine.indexOf("GET /L") >= 0 && !autonomousMode) {
              manualTurnLeft();
            }
            else if (currentLine.indexOf("GET /R") >= 0 && !autonomousMode) {
              manualTurnRight();
            }
            else if (currentLine.indexOf("GET /S") >= 0 && !autonomousMode) {
              stopMotors();
            }

            currentLine = "";
          }
        } 
        else if (c != '\r') {
          currentLine += c;
        }
      }
    }
    client.stop();
  }

  delay(10);
}

// ========== LINE FOLLOWING WITH ANALOG SENSORS ==========
void followLine() {
  left_value = analogRead(LEFT_IR);
  right_value = analogRead(RIGHT_IR);

  // Print sensor values for debugging/calibration
  Serial.print("L: ");
  Serial.print(left_value);
  Serial.print(" | R: ");
  Serial.print(right_value);
  Serial.print(" | Dir: ");
  Serial.println(lastDirection);

  // Right sensor detects black line, left doesn't
  if (right_value >= DETECT_LIMIT && !(left_value >= DETECT_LIMIT)) {
    turnRight();
  }
  // Left sensor detects black line, right doesn't
  else if ((left_value >= DETECT_LIMIT) && !(right_value >= DETECT_LIMIT)) {
    turnLeft();
  }
  // Both sensors don't detect black line - move forward
  else if (!(left_value >= DETECT_LIMIT) && !(right_value >= DETECT_LIMIT)) {
    moveForward();
  }
  // Both sensors detect black line - stop
  else if ((left_value >= DETECT_LIMIT) && (right_value >= DETECT_LIMIT)) {
    stop();
  }
}

// ========== AUTO MODE MOVEMENT FUNCTIONS ==========
void moveForward() {
  if (lastDirection != 'F') {
    // Starting push when changing direction to forward
    digitalWrite(in1, LOW);
    digitalWrite(in2, HIGH);
    analogWrite(enA, 255);
    digitalWrite(in3, HIGH);
    digitalWrite(in4, LOW);
    analogWrite(enB, 255);
    lastDirection = 'F';
    delay(20);
  } else {
    // Normal forward speed
    digitalWrite(in1, LOW);
    digitalWrite(in2, HIGH);
    analogWrite(enA, FORWARD_SPEED);
    digitalWrite(in3, HIGH);
    digitalWrite(in4, LOW);
    analogWrite(enB, FORWARD_SPEED);
  }
}

void stop() {
  if (lastDirection != 'S') {
    // Move forward once more to verify it's actually a stop
    digitalWrite(in1, LOW);
    digitalWrite(in2, HIGH);
    analogWrite(enA, 255);
    digitalWrite(in3, HIGH);
    digitalWrite(in4, LOW);
    analogWrite(enB, 255);
    lastDirection = 'S';
    delay(40);
  } else {
    // Actually stop the robot
    stopMotors();
    lastDirection = 'S';
  }
}

void turnRight() {
  if (lastDirection != 'R') {
    // First time right turn - slight turn
    lastDirection = 'R';
    analogWrite(enA, 0);
    analogWrite(enB, 0);
    delay(BEFORE_TURN_DELAY);
    
    // Left motor forward, right motor backward (slight)
    digitalWrite(in1, LOW);
    digitalWrite(in2, HIGH);
    analogWrite(enA, TURN_SLIGHT_SPEED);
    digitalWrite(in3, LOW);
    digitalWrite(in4, HIGH);
    analogWrite(enB, TURN_SLIGHT_SPEED);
  } else {
    // Sharp right turn
    digitalWrite(in1, LOW);
    digitalWrite(in2, HIGH);
    analogWrite(enA, TURN_SHARP_SPEED);
    digitalWrite(in3, LOW);
    digitalWrite(in4, HIGH);
    analogWrite(enB, TURN_SHARP_SPEED);
  }
  delay(DELAY_AFTER_TURN);
}

void turnLeft() {
  if (lastDirection != 'L') {
    // First time left turn - slight turn
    lastDirection = 'L';
    analogWrite(enA, 0);
    analogWrite(enB, 0);
    delay(BEFORE_TURN_DELAY);
    
    // Right motor forward, left motor backward (slight)
    digitalWrite(in1, HIGH);
    digitalWrite(in2, LOW);
    analogWrite(enA, TURN_SLIGHT_SPEED);
    digitalWrite(in3, HIGH);
    digitalWrite(in4, LOW);
    analogWrite(enB, TURN_SLIGHT_SPEED);
  } else {
    // Sharp left turn
    digitalWrite(in1, HIGH);
    digitalWrite(in2, LOW);
    analogWrite(enA, TURN_SHARP_SPEED);
    digitalWrite(in3, HIGH);
    digitalWrite(in4, LOW);
    analogWrite(enB, TURN_SHARP_SPEED);
  }
  delay(DELAY_AFTER_TURN);
}

// ========== MANUAL CONTROL FUNCTIONS ==========
void manualBackward() {
  digitalWrite(in1, LOW);
  digitalWrite(in2, HIGH);
  analogWrite(enA, 150);
  digitalWrite(in3, HIGH);
  digitalWrite(in4, LOW);
  analogWrite(enB, 150);
}

void manualForward() {
  digitalWrite(in1, HIGH);
  digitalWrite(in2, LOW);
  analogWrite(enA, 150);
  digitalWrite(in3, LOW);
  digitalWrite(in4, HIGH);
  analogWrite(enB, 150);
}

void manualTurnRight() {
  digitalWrite(in1, HIGH);
  digitalWrite(in2, LOW);
  analogWrite(enA, 100);
  digitalWrite(in3, HIGH);
  digitalWrite(in4, LOW);
  analogWrite(enB, 150);
}

void manualTurnLeft() {
  digitalWrite(in1, LOW);
  digitalWrite(in2, HIGH);
  analogWrite(enA, 150);
  digitalWrite(in3, LOW);
  digitalWrite(in4, HIGH);
  analogWrite(enB, 100);
}

void stopMotors() {
  digitalWrite(in1, LOW);
  digitalWrite(in2, LOW);
  digitalWrite(in3, LOW);
  digitalWrite(in4, LOW);
  analogWrite(enA, 0);
  analogWrite(enB, 0);
}

// ========== WEB PAGE ==========
void sendWebPage(WiFiClient &client) {
  client.println("HTTP/1.1 200 OK");
  client.println("Content-type:text/html");
  client.println();
  client.println("<!DOCTYPE html><html><head>");
  client.println("<meta name='viewport' content='width=device-width, initial-scale=1'>");
  client.println("<title>Line Follower</title>");
  client.println("</head><body style='text-align:center;font-family:Arial;'>");

  client.println("<h1>ðŸ¤– Line Follower Robot</h1>");
  client.println("<p>Analog IR Sensors</p>");

  client.println("<button onclick=\"fetch('/AUTO_ON')\">AUTO ON</button><br><br>");
  client.println("<button onclick=\"fetch('/AUTO_OFF')\">AUTO OFF</button><br><br>");

  client.println("<button onclick=\"fetch('/F')\">FORWARD</button><br><br>");
  client.println("<button onclick=\"fetch('/L')\">LEFT</button>");
  client.println("<button onclick=\"fetch('/S')\">STOP</button>");
  client.println("<button onclick=\"fetch('/R')\">RIGHT</button><br><br>");
  client.println("<button onclick=\"fetch('/B')\">BACK</button>");

  client.println("</body></html>");
}